function Approval(){this.switchStr=!0,this.expenseImageUrl=[],this.expenseImageName=[],this.config={productType:document.querySelector("#productType"),myModal:document.querySelector("#myModal"),addBtn:document.querySelector("#addBtn"),inWrap:document.querySelector("#inWrap"),cashierWrap:document.querySelector("#cashierWrap"),bankAccount:document.querySelector("#bankAccount"),accountName:document.querySelector("#accountName"),accounNumber:document.querySelector("#accounNumber"),expenseTotal:document.querySelector("#expenseTotal"),epUserWrap:document.querySelector("#epUserWrap"),departmentWrap:document.querySelector("#departmentWrap"),breadcrumb:document.querySelector("#breadcrumb"),approverWrap:document.querySelector("#approverWrap"),uploadBtn:document.querySelector("#uploadBtn"),myFile:document.querySelector("#myFile"),uploadWrap:document.querySelector("#uploadWrap")}}var slideout=new Slideout({panel:document.getElementById("panel"),menu:document.getElementById("menu"),padding:256,tolerance:70,touch:!1});Approval.prototype={throttle:function(e,a){clearTimeout(e.tId),e.tId=setTimeout(function(){e.call(a)},200)},getProductType:function(){var e=this;$.ajax({url:getRoothPath+"/ddExpenses/userController/reviewType",success:function(a){if("{}"===JSON.stringify(a))return $my.messageInfo.html("暂无数据").fadeIn("fast").delay("1000").fadeOut("slow"),!1;switch(a.status){case"true":var t=a.info;if("{}"===JSON.stringify(t))return $my.messageInfo.html("暂无报销类型").fadeIn("fast").delay("1000").fadeOut("slow"),!1;var r=t.data;if(!r.length)return $my.messageInfo.html("报销类型为空").fadeIn("fast").delay("1000").fadeOut("slow"),!1;for(var s="",o=0,n=r.length;o<n;o++)s+='<li class="list-group-item" data-producttypeid='+r[o].productTypeID+">"+r[o].productTypeName+"</li>";e.config.productType.innerHTML=s,e.selectProductType();break;case"failure":$my.messageInfo.html("查询错误").fadeIn("fast").delay("1000").fadeOut("slow")}}})},selectProductType:function(){var e=this,a="",t=this.config.productType.querySelectorAll("li");t=Array.prototype.slice.apply(t),$(e.config.inWrap).on("touchend",".product",function(e){e.preventDefault(),e.stopPropagation(),a=parseInt($(this).parents("#appendChild")[0].dataset.index),$(myModal).modal("show")});for(var r=0,s=t.length;r<s;r++)t[r].addEventListener("click",function(t){t.preventDefault(),t.stopPropagation();var r=this.innerHTML,s=this.dataset.producttypeid,o=e.config.inWrap.querySelectorAll(".appendChild");Array.prototype.forEach.call(o,function(e,t){a===t&&(e.querySelector(".product").value=r,e.querySelector(".product").dataset.productid=s)}),$(myModal).modal("hide")},!1)},addEvents:function(){var e=0,a="",t="",r=this;r.config.addBtn.addEventListener("click",function(){if(++e>2)return $my.messageInfo.html("最多添加2个报销").fadeIn("fast").delay("1000").fadeOut("slow"),!1;switch(e){case 1:t="报销二";break;case 2:t="报销三"}a+='<div id="appendChild" class="appendChild" data-index='+e+">",a+='<p class="titleMessage">'+t+"</p>",a+='<div class="container-fluid myContainer inputFile">',a+='<div class="row my-row">',a+='<div class="col-xs-3 col-sm-3 col-md-3 my-col">',a+="<span>报销类型</span>",a+="</div>",a+='<div class="col-xs-9 col-sm-9 col-md-9 my-col">',a+='<input type="text" class="product" data-productid="" readonly="readonly" data-toggle="modal" data-target="#myModal" placeholder="请输入">',a+="</div>",a+="</div>",a+='<div class="row my-row">',a+='<div class="col-xs-4 col-sm-4 col-md-4 my-col">',a+="<span>报销金额(￥)</span>",a+="</div>",a+='<div class="col-xs-8 col-sm-8 col-md-8 my-col">',a+='<input type="number" class="itemAlltotals" data-count="0" placeholder="请输入">',a+="</div>",a+="</div>",a+='<div class="row my-row special-row">',a+='<div class="col-xs-3 col-sm-3 col-md-3 my-col">',a+="<span>费用说明</span>",a+='<span class="limit">(150字)</span>',a+="</div>",a+='<div class="col-xs-9 col-sm-9 col-md-9 my-col">',a+='<textarea class="remarks" placeholder="请输入" maxlength="150"></textarea>',a+="</div>",a+="</div>",a+="</div>",a+="</div>",$(r.config.inWrap).append(a),a=""},!1)},getCashierUser:function(){var e=this;$.ajax({url:getRoothPath+"/ddExpenses/userController/cashierUser",success:function(a){if("{}"===JSON.stringify(a))return $my.messageInfo.html("暂无数据").fadeIn("fast").delay("1000").fadeOut("slow"),!1;switch(a.status){case"true":var t=a.info;if("{}"===JSON.stringify(t))return void $my.messageInfo.html("返回信息为空").fadeIn("fast").delay("1000").fadeOut("slow");var r=t.data;if(!r.length)return void $my.messageInfo.html("出纳人信息为空").fadeIn("fast").delay("1000").fadeOut("slow");for(var s="",o=0,n=r.length;o<n;o++)s+='<li class="cashier text-center" data-cashierUserID='+r[o].cashierUserID+">",s+='<div class="wating text-center progressBar">出纳</div>',s+='<p class="name">'+r[o].cashierUserName+"</p>",s+="</li>";e.config.cashierWrap.innerHTML=s;break;case"failure":$my.messageInfo.html("查询错误").fadeIn("fast").delay("1000").fadeOut("slow")}}})},getOldBank:function(e){var a=this;if(null==e||"null"==e)return void $my.messageInfo.html("用户ID丢失").fadeIn("fast").delay("1000").fadeOut("slow");$.ajax({url:getRoothPath+"/ddExpenses/userController/getOldBank",data:{userID:1},success:function(e){if("{}"===JSON.stringify(e))return $my.messageInfo.html("暂无数据").fadeIn("fast").delay("1000").fadeOut("slow"),!1;switch(e.status){case"true":var t=e.info;if("{}"===JSON.stringify(t))return void $my.messageInfo.html("返回信息为空").fadeIn("fast").delay("1000").fadeOut("slow");var r=t.data;r.length&&(a.config.bankAccount.value=r[0].bankAccount,a.config.accountName.value=r[0].accountName,a.config.accounNumber.value=r[0].accounNumber);break;case"failure":$my.messageInfo.html("查询错误").fadeIn("fast").delay("1000").fadeOut("slow")}}})},calcExpenseTotal:function(){var e=this,a=/^\d+(\.\d+)?$/;$(e.config.inWrap).on("keyup",".itemAlltotals",function(t){var r=0;if(t.preventDefault(),t.stopPropagation(),""!=this.value){if(!a.test(this.value))return void $my.messageInfo.html("请输入非负浮点数").fadeIn("fast").delay("1000").fadeOut("slow");parseFloat(this.value)<=1e6?this.dataset.count=this.value:($my.messageInfo.html("单个报销金额最大100万").fadeIn("fast").delay("1500").fadeOut("slow"),this.value="",this.dataset.count=0)}else""==this.value&&(this.dataset.count=0);var s=$(this).parents("#inWrap")[0].querySelectorAll(".itemAlltotals");Array.prototype.forEach.call(s,function(e){r+=parseFloat(e.dataset.count)}),e.config.expenseTotal.value=r.toFixed(4)})},getEpUser:function(e){var a=this;if(null==e||"null"==e)return $my.messageInfo.html("用户ID丢失").fadeIn("fast").delay("1000").fadeOut("slow"),!1;$.ajax({url:getRoothPath+"/ddExpenses/userController/oldExpensesUser",data:{userID:1},success:function(e){if("{}"===JSON.stringify(e))return $my.messageInfo.html("暂无数据").fadeIn("fast").delay("1000").fadeOut("slow"),!1;switch(e.status){case"true":var t=e.info;if("{}"===JSON.stringify(t))return void $my.messageInfo.html("返回信息为空").fadeIn("fast").delay("1000").fadeOut("slow");var r=t.data;if(r.length){for(var s="",o=0,n=r.length;o<n;o++)s+='<li class="nowrap text-center" data-oldEpUserID='+r[o].oldEpUserID+">"+r[o].oldEpUserUserName+"</li>";a.config.epUserWrap.innerHTML=s}break;case"failure":$my.messageInfo.html("查询错误").fadeIn("fast").delay("1000").fadeOut("slow")}}})},_renderDepart:function(e){var a="",t=e.listUser,r=e.listDepart;if(r.length)for(var s=0,o=r.length;s<o;s++)a+='<div class="row my-row" data-departID='+r[s].departID+">",a+='<div class="col-xs-8 col-sm-8 col-md-8 my-col nowrap">',a+='<span class="departName">'+r[s].departName+"</span>",a+="</div>",a+='<div class="col-xs-4 col-sm-4 col-md-4 my-col text-right">',a+="<p><i>"+r[s].userCount+'</i>&nbsp;<span class="glyphicon glyphicon-menu-right" aria-hidden="true"></span></p>',a+="</div>",a+="</div>";if(t.length)for(var s=0,o=t.length;s<o;s++)a+='<div class="row my-row" data-departUserID='+t[s].departUserID+">",a+='<div class="col-xs-8 col-sm-8 col-md-8 my-col nowrap">',a+='<span class="departUserName">'+t[s].departUserName+"</span>",a+="</div>",a+='<div class="col-xs-4 col-sm-4 col-md-4 my-col text-right">',a+='<p><span class="glyphicon glyphicon-ok my-icon" aria-hidden="true"></span></p>',a+="</div>",a+="</div>";this.config.departmentWrap.innerHTML=a,this.switchStr=!0},getDepart:function(e){var a=this;$.ajax({url:getRoothPath+"/ddExpenses/userController/getDepartOrUser",data:{departmentID:e},success:function(e){if("{}"===JSON.stringify(e))return $my.messageInfo.html("暂无数据").fadeIn("fast").delay("1000").fadeOut("slow"),!1;switch(e.status){case"true":var t=e.info;if("{}"===JSON.stringify(t))return void $my.messageInfo.html("返回信息为空").fadeIn("fast").delay("1000").fadeOut("slow");a._renderDepart(t);break;case"failure":$my.messageInfo.html("部门及人员获取错误").fadeIn("fast").delay("1000").fadeOut("slow")}}})},asyncGetDepart:function(){var e=this;$(departmentWrap).on("click",".row",function(a){a.preventDefault(),a.stopPropagation();var t=document.createElement("li"),r=this.dataset.departid,s="";if(this.querySelector(".departName"))s=this.querySelector(".departName").innerHTML,t="<li data-departmentID="+r+'><a href="javascript:;">'+s+"</a></li>",e.getDepart(r),$(e.config.breadcrumb).append(t);else{var o="",n="",l="";o=this.querySelector(".departUserName").innerHTML,n=this.dataset.departuserid;var i=e.config.approverWrap.querySelectorAll("li");if(i.length>=10)return void $my.messageInfo.html("审批人最多添加9名").fadeIn("fast").delay("1000").fadeOut("slow");Array.prototype.forEach.call(i,function(e){if(n==e.dataset.userid)throw $my.messageInfo.html("该审批人已在列表中").fadeIn("fast").delay("1000").fadeOut("slow"),new Error("该审批人已在列表中")}),this.querySelector(".my-icon").classList.add("hasselect"),l='<li class="nowrap addPeople" data-userid='+n+">"+o+"</li>",e.config.approverWrap.insertAdjacentHTML("afterBegin",l),slideout.close()}var d=e.config.breadcrumb.querySelectorAll("li");d=Array.prototype.slice.call(d),d.pop();for(var c=0,u=d.length;c<u;c++)d[c].classList.add("active")})},crumbsEvent:function(){var e=this;$(breadcrumb).on("click","li",function(a){if(a.preventDefault(),a.stopPropagation(),e.switchStr&&this.classList.contains("active")){this.classList.remove("active"),e.switchStr=!1;var t="",r=this.dataset.departmentid,s=$(this).index(),o=this.parentNode.querySelectorAll("li");o=Array.prototype.slice.apply(o),o=o.slice(0,s+1);for(var n=0,l=o.length;n<l;n++)t+=o[n].outerHTML;e.config.breadcrumb.innerHTML=t,e.getDepart(r)}})},selectEpUser:function(){var e=this,a="",t="",r="";$(this.config.epUserWrap).on("click","li",function(s){s.preventDefault(),s.stopPropagation(),t=this.dataset.oldepuserid,a=this.innerHTML;var o=e.config.approverWrap.querySelectorAll("li");Array.prototype.forEach.call(o,function(e){if(t==e.dataset.userid)throw $my.messageInfo.html("该审批人已在列表中").fadeIn("fast").delay("1000").fadeOut("slow"),new Error("该审批人已在列表中")}),r='<li class="nowrap addPeople" data-userid='+t+">"+a+"</li>",e.config.approverWrap.insertAdjacentHTML("afterBegin",r),slideout.close()})},submitEvent:function(){var e=[],a=approval.config.expenseTotal.value,t=approval.config.bankAccount.value,r=approval.config.accountName.value,s=approval.config.accounNumber.value,o=[],n=[],l=[],i=[],d=approval.config.cashierWrap.querySelector("li.cashier").dataset.cashieruserid,c=approval.config.inWrap.querySelectorAll(".product"),u=approval.config.inWrap.querySelectorAll(".itemAlltotals"),p=approval.config.inWrap.querySelectorAll(".remarks"),f=approval.config.approverWrap.querySelectorAll(".nowrap"),c=Array.prototype.slice.apply(c);u=Array.prototype.slice.apply(u),p=Array.prototype.slice.apply(p),Array.prototype.forEach.call(f,function(e){i.push(e.dataset.userid)});for(var m=0,y=c.length;m<y;m++){if(""==c[m].dataset.productid)return void $my.messageInfo.html("请完善报销类型").fadeIn("fast").delay("1000").fadeOut("slow");if(""==u[m].value)return void $my.messageInfo.html("请完善报销金额").fadeIn("fast").delay("1000").fadeOut("slow");o.push(c[m].dataset.productid),n.push(u[m].value),l.push(p[m].value)}if(""==t||""==r||""==s)return void $my.messageInfo.html("请完善收款信息").fadeIn("fast").delay("1000").fadeOut("slow");if(""==a)return void $my.messageInfo.html("报销总金额为空").fadeIn("fast").delay("1000").fadeOut("slow");if(0===approval.expenseImageUrl.length)return void $my.messageInfo.html("请完善报销凭证").fadeIn("fast").delay("1000").fadeOut("slow");if(0===i.length)return void $my.messageInfo.html("请完善审批人").fadeIn("fast").delay("1000").fadeOut("slow");if(""==d)return void $my.messageInfo.html("出纳人信息为空").fadeIn("fast").delay("1000").fadeOut("slow");o=o.join(),n=n.join(),l=l.join(),i=i.join();for(var m=0,y=approval.expenseImageUrl.length;m<y;m++)e.push(clouddnImgStr+"/"+approval.expenseImageUrl[m]);$.ajax({url:getRoothPath+"/ddExpenses/expense/save",data:{expenseTotal:a,submitUserID:$my.userID,bankAccount:t,accountName:r,accounNumber:s,producttypeIDs:o,itemAlltotals:n,remarks:l,expensesUserIDs:i,cashierUserID:d,expenseImageUrl:e.join(),expenseImageName:approval.expenseImageName.join()},success:function(e){if("{}"===JSON.stringify(e))return $my.messageInfo.html("暂无数据").fadeIn("fast").delay("1000").fadeOut("slow"),!1;switch(e.status){case 1:$my.messageInfo.html(e.msg).fadeIn("fast").delay("1000").fadeOut("slow");break;case 0:$my.messageInfo.html("保存失败").fadeIn("fast").delay("1000").fadeOut("slow")}}}),function(){e=null,o=null,n=null,l=null,i=null}()},addImage:function(){var e=this;e.config.uploadBtn.addEventListener("click",function(){$(myFile).trigger("click")},!1);var a=function(a){var t=document.createElement("img"),r=document.createElement("li");r.classList.add("newUploadImg"),t.file=a,r.appendChild(t),$(e.config.uploadWrap).prepend(r);var s=new FileReader;s.onload=function(e){return function(a){e.src=a.target.result}}(t),s.readAsDataURL(a)};e.config.myFile.addEventListener("change",function(t){t.stopPropagation(),t.preventDefault();var r=new FormData,s=this.files;if(!(s.length<=9))return void $my.messageInfo.html("单次图片最多上传9张").fadeIn("fast").delay("1000").fadeOut("slow");var o=e.config.uploadWrap.querySelectorAll("li");if(o=Array.prototype.slice.apply(o),!(s.length<=10-o.length))return void $my.messageInfo.html("单次图片最多上传9张").fadeIn("fast").delay("1000").fadeOut("slow");for(var n=0,l=s.length;n<l;n++){var i=s[n],d=i.name.split(".")[1].toLowerCase();if("jpg"!==d&&"jpeg"!==d&&"png"!==d)return void $my.messageInfo.html("请选择扩展名.jpg/.jpeg/.png图片").fadeIn("fast").delay("1500").fadeOut("slow");if(i.size>3145728)return void $my.messageInfo.html("单张图片大小不可超过3M").fadeIn("fast").delay("1000").fadeOut("slow");r.append("files",i),a(i)}0!=s.length&&$.ajax({url:"http://www.ehaofangwang.com/publicshow/qiniuUtil/fileToQiniu",type:"POST",data:r,timeout:"",dataType:"json",cache:!1,contentType:!1,processData:!1,success:function(a){if("{}"===JSON.stringify(a))return void $my.messageInfo.html("返回信息为空").fadeIn("fast").delay("1000").fadeOut("slow");var t=a.statas,s="",o="";switch(t){case"true":s=a.pathUrls.split(","),o=a.fileNames.split(","),Array.prototype.push.apply(e.expenseImageUrl,s),Array.prototype.push.apply(e.expenseImageName,o),$my.messageInfo.html(a.message).fadeIn("fast").delay("1000").fadeOut("slow");break;case"false":$my.messageInfo.html("上传失败,请重新上传").fadeIn("fast").delay("1500").fadeOut("slow"),r=null,s=[],$(e.config.uploadWrap).find("li.newUploadImg").remove()}},error:function(a){r=null,$(e.config.uploadWrap).find("li.newUploadImg").remove()}})},!1)},init:function(){this.getProductType(),this.getCashierUser(),this.getOldBank($my.userID),this.addEvents(),this.calcExpenseTotal(),this.getDepart(0),this.asyncGetDepart(),this.getEpUser($my.userID),this.crumbsEvent(),this.selectEpUser(),this.addImage()}};var approval=new Approval;$(function(){window.$my={messageInfo:$(".messageInfo"),userID:sessionStorage.getItem("ddUserID")},approval.init(),document.querySelector("#addApprover").addEventListener("click",function(e){e.preventDefault(),e.stopPropagation(),slideout.open()},!1),document.querySelector("#closeBtn").addEventListener("touchend",function(e){e.preventDefault(),e.stopPropagation(),slideout.close()},!1),document.querySelector("#submitBtn").addEventListener("click",function(e){e.preventDefault(),e.stopPropagation(),approval.throttle(approval.submitEvent,this)},!1)});